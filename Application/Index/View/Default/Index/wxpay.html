<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html>
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <meta charset="utf-8">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <meta name="msapplication-tap-highlight" content="no" />
    <meta content="no-cache" http-equiv="Pragma">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, minimum-scale=1, user-scalable=no, minimal-ui">
    <meta content="telephone=no, address=no" name="format-detection">
    <link rel="stylesheet" href="{$resyuming}Public/css/bootstrap.min.css?v={$static_v}"/>
    <link rel="stylesheet" href="{$resyuming}Public/css/orderDetail.css?v={$static_v}"/>
    <title>微信安全支付</title>
    <script language="javascript">
    var isPaying = false;
    function getPayRequest(){
        if(isPaying) {return;}
        isPaying = true;
        WeixinJSBridge.invoke('getBrandWCPayRequest',
            {$jsApiParameters},
            function(res){
                isPaying = false;
                switch (res["err_msg"]) {
                    case "get_brand_wcpay_request:ok":
                        document.location.href = "{$successurl}";
                        break;
                    case "get_brand_wcpay_request:cancel":
//                      alert(res["err_msg"]);
                        break;
                    default:
	                    alert("非常抱歉，支付订单失败了，请重新尝试一次。");
                        break;
                }
                // 使用以上方式判断前端返回,微信团队郑重提示：res.err_msg 将在用户支付成功后返回 ok，但并不保证它绝对可靠。
                // 因此微信团队建议，当收到ok返回时，向商户后台询问是否收到交易成功的通知，若收到通知，前端展示交易成功的界面
                // 若此时未收到通知，商户后台主动调用查询订单接口，查询订单的当前状态，并反馈给前端展示相应的界面。
            });
    }

    //当微信内置浏览器完成内部初始化后会触发WeixinJSBridgeReady事件。
    document.addEventListener(
        'WeixinJSBridgeReady',
        function onBridgeReady() {
            //公众号支付
            jQuery('a#getBrandWCPayRequest').click(getPayRequest);
            WeixinJSBridge.log('支付进行中.');
        },
        false);
    </script>
</head>
<body>

<div class="panel panel-default">
    <div class="panel-heading">订单信息</div>
    <div class="panel-body">
        <div>
            <table class="table" style="margin-bottom:10px">
                <tbody>
                    <tr> <td>订单号: </td> <td> {$orderData.orderno} </td> </tr>
                    <tr> <td>商品: </td> <td> {$orderData.picCount} 张六寸照片</td> </tr>
                    <tr> <td>价格: </td> <td> &yen; {$orderData.photo_fee} </td> </tr>
                    <tr>
                        <td>邮费: </td>
                        <td>
                            &yen; {$orderData.postage}<br>
                            <if condition="$orderData.postage gt 0">
                            <pre style="max-width: 10rem;margin: 0px;">{$postExceptArea}需加{$orderData.postage}元邮费</pre>
                            </if>
                        </td>
                    </tr>
                    <tr> <td>总计: </td> <td> <span style="color:red;">&yen; {$orderData.price}</span> </td> </tr>
                </tbody>
            </table>
            <hr style="margin-top: 0;margin-bottom:10px"/>
            <table class="table" style="margin-bottom:10px">
                <tbody>
                    <tr> <td>收货人: </td> <td> {$contactData.name} </td> </tr>
                    <tr> <td>联系电话: </td> <td> {$contactData.phone} </td> </tr>
                    <tr> <td>收货地址: </td> <td style="max-width: 10rem;margin: 0px; word-break: break-all;"> {$contactData.address}<br>{$contactData.street} </td> </tr>
                </tbody>
            </table>
            <hr style="margin-top: 0;margin-bottom:10px"/>
        </div>
        <div class="submit-btn">
            <a class="btn btn-default" style="margin-right:50px;" href="/Index/Index/order/cid/{$orderData.cid}">返回编辑</a>
            <a class="btn btn-success" id="getBrandWCPayRequest" href="javascript:getPayRequest();">微信支付</a>
        </div>

    </div>
</div>
<div style="display:none">
    <script src="http://s4.cnzz.com/z_stat.php?id=1256866199&web_id=1256866199" language="JavaScript"></script>
</div>
</body>
</html>