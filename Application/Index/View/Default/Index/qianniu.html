<!DOCTYPE html>
<html>
<head lang="en">
    <meta charset="UTF-8">
    <style>
        .order {
            border: solid 1px black;
        }
    </style>
    <title></title>
</head>
<body>
<button onclick="getActiveUser(1);">付款订单</button>
<button onclick="getActiveUser(0);">未付款订单</button>
<div id="orderList">
</div>
</body>
<script src="http://g.tbcdn.cn/sj/qn/jssdk.js"></script>
<script src="{$resyuming}Public/js/zepto.min.js?v={$static_v}"></script>
<script>
    function getActiveUser(isPaid) {
        //手动按钮触发获取当前接待用户的userid
        QN.application.invoke( {
            cmd : 'getActiveUser',
            param : {},
            error : function(msg, cmd, param) {
                alert("event failed");
            },
            success : function(rsp, cmd, param) {
                var uid = rsp.uid.substring(8);
                getOrder(uid, isPaid);
            }
        });
    }

    var isGet = false;
    function getOrder(uid, isPaid) {
        if(isGet) {
            return;
        }
        isGet = true;
        $.ajax({
            url: "/Index/Api/getOrderListTaobao?uid="+uid+"&isPaid="+isPaid,
            type: 'GET',
            crossDomain: true,
            contentType: "application/json; charset=utf-8",
            success: function (data) {
                isGet = false;
                if(data.status == 'ok') {
                    data = data.data;
                    var html = "";
                    for(var i= 0,len=data.length;i<len;++i) {
                        html += "<div class='order'><span>订单号: "+data[i].orderno+"</span><br/><span>商品: 六寸照片("
                        +data[i].photo_number+")张</span><br/>";
                        if(data[i].mailno) {
                            html += "<span>物流单号: "+data[i].mailno+"</span><br/>";
                        } else {
                            html += "<span>物流单号: 无</span><br/>";
                        }
                        html += "<span>联系方式: "+data[i].name+"("+data[i].phone+")</span><br/><span>联系地址: "+data[i].province+data[i].city+data[i].area+data[i].street
                        +"</span><br/><span>下单时间: "+data[i].paidTime+"</span></div>";
                    }
                    if(!html) {
                        html = "暂无订单信息";
                    }
                    $("#orderList").html(html);
                } else {
                    alert("获取订单失败: "+data.reason);
                }
            },
            error: function() {
                isGet = false;
                alert("获取订单失败");
            }
        });
    }

    $(function(){
        //注册监听联系人切换的事件，千牛客户端主动发送内容给前端页面
        QN.event.regEvent( {
            eventId : 'wangwang.active_contact_changed',
            success : function(eventId) {
                getActiveUser(1);
            },
            error : function(msg, eventId) {
                alert("event failed");
            },
            notify : function(data, eventId) {
                var uid = JSON.parse(data);
                uid = uid.newContact.substring(8);
                getOrder(uid, 1);
            }
        });
    })
</script>
</html>